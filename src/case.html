<!DOCTYPE html>
<html lang="fr">

<audio id="audio-jour" loop></audio>

<div id="overlay-jour" style="
  position: fixed;
  inset: 0;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
">
  <div style="background: rgba(0,0,0,0.45); padding: 20px 24px; border-radius: 16px; color: #fff; max-width: 90vw;">
    <h1 id="overlay-texte">Texte dâ€™intro</h1>
    <button id="overlay-btn" style="
      margin-top: 16px;
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    ">
      DÃ©couvrir le cadeau
    </button>
  </div>
</div>

<div id="volume-bar" style="
    position: fixed;
  right: 12px;
  bottom: 12px;
  background: rgba(0,0,0,0.6);
  padding: 6px 8px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 5000;
  opacity: 0.85;
">
  <button id="music-toggle" style="
    border:none;
    background:transparent;
    color:white;
    cursor:pointer;
    font-size:0.9em;
  ">âµ</button>
  <span style="color:white;font-size:0.8em;">ğŸµ</span>
  <input id="volume-range" type="range" min="0" max="1" step="0.01" value="0.1">
</div>
<div id="contenu"></div>
<div id="avertissement">
  ğŸ Ce cadeau ne sera disponible que le <span id="dateJour"></span> dÃ©cembre !<br>
  Reviens Ã  la bonne date ğŸ˜‰
</div>
<script>
  // GÃ©nÃ©rer un entier alÃ©atoire entre 1 et 5
  const randomInt = Math.floor(Math.random() * 3) + 1;
  // RÃ©cupÃ¨re le numÃ©ro du jour depuis l'URL
  const params = new URLSearchParams(window.location.search);
  const jour = Number(params.get('jour'));
  const today = new Date();
  // === Astuce pour testÂ : dÃ©commente la ligne suivante pour simuler une date ==== 
  today.setMonth(11); today.setDate(2); // 0=jan, 6=dÃ©c

  // VÃ©rifie si la case est "ouverte" Ã  la bonne date
  const estOuvert = (today.getMonth() + 1 > 12) || (today.getMonth() + 1 === 12 && today.getDate() >= jour);

  const zone = document.getElementById('contenu');
  const avert = document.getElementById('avertissement');
  const spanJour = document.getElementById('dateJour');

  const overlay = document.getElementById('overlay-jour');
  const overlayTexte = document.getElementById("overlay-texte");
  const overlayBtn = document.getElementById("overlay-btn");
  const audio = document.getElementById('audio-jour');
  const volumeBar = document.getElementById('volume-range');
  const musicToggle = document.getElementById('music-toggle');

  // Gestion du volume
  if (audio && volumeBar && musicToggle) {
    audio.volume = parseFloat(volumeBar.value);
    volumeBar.addEventListener('input', () => {
      audio.volume = parseFloat(volumeBar.value);
    });

    musicToggle.addEventListener('click', () => {
      if (audio.paused) {
        audio.play().then(() => {
          musicToggle.textContent = "â¸";
        }).catch(() => {});
      } else {
        audio.pause();
        musicToggle.textContent = "âµ";
      }
    })
  }

  if (!estOuvert) {
    zone.style.display = "none";
    avert.style.display = "block";
    spanJour.textContent = jour || "?";
  } else {
    // Affichage du contenu seulement au bon jour
    avert.style.display = "none";
    fetch('contenus.json')
      .then(response => {
        if (!response.ok) throw new Error('Erreur de chargement du contenu !');
        return response.json();
      })
      .then(contenus => {
        const zone = document.getElementById('contenu');
        if (contenus[jour]) {
          zone.innerHTML = contenus[jour];
        } else {
          zone.textContent = 'Aucune information pour ce jour.';
        }

        // Une fois le contenu injectÃ©, on gÃ¨re la scÃ¨ne d'intro + musique
        gereOverlayEtMusique();;
      })
      .catch(() => {
        zone.textContent = "Calendrier indisponible pour le moment.";
      });
  }

  // function gereOverlayEtMusique() {
  //   if (!overlay || !overlayBtn || !audio) return;
  //   if (!jour) return;

  //   audio.src=`music/jour${jour}.mp3`; // fichier audio jourX.mp3

  //   // Si la scÃ¨ne a dÃ©jÃ  Ã©tÃ© jouÃ©e pour ette case, ne rien refaire
  //   musicToggle.textContent = "â¸";

  //   // On est dÃ©jÃ  sÃ»r qu'estOuvert est true ici, donc bonne date
  //   audio.play().catch(()=>{});
    
  // };

  // Fonction avec intro

    function gereOverlayEtMusique() {
    if (!overlay || !overlayBtn || !audio) return;
    if (!jour) return;

    const cleIntro = "introVue_jour" + jour;
    audio.src=`music/jour${jour}.mp3`; // fichier audio jourX.mp3

    // Si la scÃ¨ne a dÃ©jÃ  Ã©tÃ© jouÃ©e pour cette case, ne rien refaire
    if (localStorage.getItem(cleIntro) === "1") {
      return;
    }
    musicToggle.textContent = "â¸";

    // On est dÃ©jÃ  sÃ»r qu'estOuvert est true ici, donc bonne date

    // PrÃ©parer visuel + son
    overlay.style.backgroundImage = `url('Images/Cadeau/cadeau${randomInt}.jpg')`;
    overlayTexte.textContent = "Joyeux " + jour + " dÃ©cembre !";

    // Masquer le contenu le temps de l'intro
    zone.style.visibility = "hidden";
    overlay.style.display = "flex";

    overlayBtn.addEventListener('click', function () {
      // Marque l'intro comme vue pour cette case
      localStorage.setItem(cleIntro, "1");

      // Cache l'overlay, affiche le contenu
      overlay.style.display = "none";
      zone.style.visibility = "visible";

      // Lance la musique (clic utilisateur => autorisÃ©)
      audio.play().catch(()=>{});
    })
  }
</script>

</html>